<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Roue du coaching - Yendo_Jr ‚ö°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@master/Winwheel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            color: #fff;
            font-family: 'Bangers', cursive;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            font-size: 48px;
            margin-top: 30px;
            text-shadow: 2px 2px 8px #ff0059;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); color: #ff0059; }
            50% { transform: scale(1.05); color: #00d4ff; }
        }

        .main-content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 20px;
        }

        .wheel-container {
            position: relative;
            width: 500px;
        }

        .pointer {
            position: absolute;
            left: 50%;
            top: -20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #ff0059;
            transform: translateX(-50%);
            z-index: 10;
        }

        canvas {
            display: block;
            margin: 30px auto 10px auto;
            box-shadow: 0 0 25px #00ffea;
            border-radius: 12px;
        }

        button {
            margin: 10px;
            padding: 12px 30px;
            font-size: 22px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: linear-gradient(45deg, #ff0059, #00d4ff);
            color: white;
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
            box-shadow: 0 0 10px #ff0059;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #00d4ff;
        }

        #game-id {
            margin-top: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #00ffe7;
            text-shadow: 1px 1px 5px #ff0059;
        }

        #counter {
            margin-top: 10px;
            font-size: 22px;
            color: #FFD700;
            text-shadow: 0 0 5px #ff0059;
        }

        #winners, #active-users {
            width: 200px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            box-shadow: 0 0 10px #00ffea;
        }

        #winners h2, #active-users h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #00d4ff;
        }

        #winners ul, #participant-list {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }

        #winners li, #participant-list li {
            font-size: 18px;
            margin-bottom: 5px;
            color: #fff;
        }

        #participant-list button {
            margin-left: 10px;
            font-size: 14px;
            padding: 3px 8px;
            border-radius: 6px;
            background: #ff0059;
            border: none;
            cursor: pointer;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>üéÆ Roue du coaching ‚Äì Yendo_Jr ‚ö°</h1>

    <div class="main-content">
        <div id="winners">
            <h2>‚úÖ Coach√©s</h2>
            <ul id="winner-list"></ul>
        </div>

        <div id="active-users">
            <h2>üéØ Participants actifs</h2>
            <ul id="participant-list"></ul>
        </div>

        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="canvas" width="500" height="500"></canvas>
            <button onclick="spinWheel()">Lancer la roue</button>
            <button onclick="resetWheel()">Reset la roue</button>
            <div id="game-id"></div>
            <div id="counter">üéØ Participants d√©j√† coach√©s : <span id="count">0</span></div>
        </div>
    </div>

    <script>
        let wheel;
        let currentData = {};
        let lastParticipantsKey = "";
        const winnerList = [];

        async function fetchParticipants() {
            const res = await fetch("https://botcoachbackend.onrender.com/participants");
            const data = await res.json();
            const newKey = JSON.stringify(Object.keys(data).sort());
            if (newKey === lastParticipantsKey) return;

            lastParticipantsKey = newKey;
            currentData = data;

            console.log("üéØ Participants mis √† jour :", data);
            rebuildWheelAfterWinner();
            updateParticipantList();
        }

        setInterval(fetchParticipants, 1000);
        fetchParticipants();

        function updateParticipantList() {
            const ul = document.getElementById('participant-list');
            ul.innerHTML = "";

            Object.entries(currentData).forEach(([name, id]) => {
                const li = document.createElement('li');
                li.innerHTML = `üë§ ${name} <button onclick="removeParticipant('${name}')">‚ùå</button>`;
                ul.appendChild(li);
            });
        }

        async function removeParticipant(name) {
            const confirmDelete = confirm(`Supprimer ${name} de la roue ?`);
            if (!confirmDelete) return;

            await fetch(`https://botcoachbackend.onrender.com/participants/${name}`, {
                method: 'DELETE'
            });

            await fetchParticipants();
        }

        function buildWheel() {
            const names = Object.keys(currentData);
            if (!names.length) names.push("Personne üò¢");

            const segmentColors = ["#ff0059", "#00d4ff", "#ffd500", "#7eff00", "#00ffea", "#ff8700", "#aa00ff"];

            wheel = new Winwheel({
                canvasId: 'canvas',
                numSegments: names.length,
                outerRadius: 220,
                textFontSize: 18,
                textOrientation: 'horizontal',
                textAlignment: 'outer',
                segments: names.map((name, i) => ({
                    text: name,
                    fillStyle: segmentColors[i % segmentColors.length],
                    textFillStyle: '#ffffff'
                })),
                animation: {
                    type: 'spinToStop',
                    duration: 6,
                    spins: 10,
                    easing: 'Power3.easeOut',
                    callbackFinished: alertWinner
                },
                lineWidth: 5,
                strokeStyle: "#111",
                innerRadius: 20
            });
        }

        function rebuildWheelAfterWinner() {
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            buildWheel();
        }

        function spinWheel() {
            const victory = document.getElementById('victory-audio');
            victory.play().then(() => {
                victory.pause();
                victory.currentTime = 0;
            }).catch(err => {
                console.log("üîá Audio autoplay bloqu√© (normal avant clic utilisateur)");
            });

            if (wheel) wheel.startAnimation();
        }

        function alertWinner(indicatedSegment) {
            const winner = indicatedSegment.text;
            const gameID = currentData[winner] || "Pas d'ID";
            document.getElementById('game-id').innerText = `üéâ GG ${winner} ! ID de game : ${gameID}`;

            confetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 }
            });

            document.getElementById('victory-audio').play();

            winnerList.push(winner);
            updateWinnerList();

            let count = parseInt(document.getElementById('count').innerText);
            document.getElementById('count').innerText = count + 1;

            delete currentData[winner];
            setTimeout(() => rebuildWheelAfterWinner(), 1000);
        }

        function updateWinnerList() {
            const ul = document.getElementById('winner-list');
            ul.innerHTML = "";
            winnerList.forEach(name => {
                const li = document.createElement('li');
                li.textContent = `ü¶∏ ${name}`;
                ul.appendChild(li);
            });
        }

        async function resetWheel() {
            document.getElementById('game-id').innerText = '';
            currentData = {};
            lastParticipantsKey = "";
            winnerList.length = 0;
            updateWinnerList();
            document.getElementById('count').innerText = '0';

            await fetch("https://botcoachbackend.onrender.com/participants", {
                method: 'DELETE'
            });

            await fetchParticipants();
        }
    </script>

    <audio id="victory-audio" preload="auto">
        <source src="sounds/victory.mp3" type="audio/mpeg">
    </audio>
</body>
</html>
