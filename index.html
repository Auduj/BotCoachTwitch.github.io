<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Roue du coaching - Yendo_Jr âš¡</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/zarocknz/javascript-winwheel@master/Winwheel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0f0f1a 100%);
            color: #fff;
            text-align: center;
            font-family: 'Bangers', cursive;
            margin: 0;
            padding: 0;
        }

        h1 {
            font-size: 48px;
            margin-top: 30px;
            text-shadow: 2px 2px 8px #ff0059;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); color: #ff0059; }
            50% { transform: scale(1.05); color: #00d4ff; }
        }

        .wheel-container {
            position: relative;
            width: 500px;
            margin: 0 auto;
        }

        .pointer {
            position: absolute;
            left: 50%;
            top: -20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 20px solid #ff0059;
            transform: translateX(-50%);
            z-index: 10;
        }

        canvas {
            display: block;
            margin: 30px auto 10px auto;
            box-shadow: 0 0 25px #00ffea;
            border-radius: 12px;
        }

        button {
            margin: 10px;
            padding: 12px 30px;
            font-size: 22px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: linear-gradient(45deg, #ff0059, #00d4ff);
            color: white;
            font-family: 'Bangers', cursive;
            letter-spacing: 1px;
            box-shadow: 0 0 10px #ff0059;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px #00d4ff;
        }

        #game-id {
            margin-top: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #00ffe7;
            text-shadow: 1px 1px 5px #ff0059;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ® Roue du coaching â€“ Yendo_Jr âš¡</h1>

    <div class="wheel-container">
        <div class="pointer"></div>
        <canvas id="canvas" width="500" height="500"></canvas>
    </div>

    <button onclick="spinWheel()">Lancer la roue</button>
    <button onclick="resetWheel()">Reset la roue</button>
    <div id="game-id"></div>

    <script>
        let wheel;
        let currentData = {};
        let lastParticipantsKey = "";

        async function fetchParticipants() {
            const res = await fetch("https://botcoachbackend.onrender.com/participants");
            const data = await res.json();
            const newKey = JSON.stringify(Object.keys(data).sort());
            if (newKey === lastParticipantsKey) return;

            lastParticipantsKey = newKey;
            currentData = data;

            console.log("ðŸŽ¯ Participants mis Ã  jour :", data);
            rebuildWheelAfterWinner();
        }

        setInterval(fetchParticipants, 5000);
        fetchParticipants();

        function buildWheel() {
            const names = Object.keys(currentData);
            if (!names.length) names.push("Personne ðŸ˜¢");

            const segmentColors = [
                "#ff0059", "#00d4ff", "#ffd500", "#7eff00", "#00ffea", "#ff8700", "#aa00ff"
            ];

            wheel = new Winwheel({
                canvasId: 'canvas',
                numSegments: names.length,
                outerRadius: 220,
                textFontSize: 18,
                textOrientation: 'horizontal',
                textAlignment: 'outer',
                segments: names.map((name, i) => ({
                    text: name,
                    fillStyle: segmentColors[i % segmentColors.length],
                    textFillStyle: '#ffffff'
                })),
                animation: {
                    type: 'spinToStop',
                    duration: 6,
                    spins: 10,
                    easing: 'Power3.easeOut',
                    callbackFinished: alertWinner
                },
                lineWidth: 5,
                strokeStyle: "#111",
                innerRadius: 20
            });
        }

        function rebuildWheelAfterWinner() {
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            buildWheel();
        }

        function spinWheel() {
            const victory = document.getElementById('victory-audio');
            victory.play().then(() => {
                victory.pause();
                victory.currentTime = 0;
            }).catch(err => {
                console.log("ðŸ”‡ Audio autoplay bloquÃ© (normal avant clic utilisateur)");
            });

            if (wheel) {
                wheel.startAnimation();
            }
        }

        function alertWinner(indicatedSegment) {
            const winner = indicatedSegment.text;
            const gameID = currentData[winner] || "Pas d'ID";
            document.getElementById('game-id').innerText = `ðŸŽ‰ GG ${winner} ! ID de game : ${gameID}`;

            confetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 }
            });

            document.getElementById('victory-audio').play();

            delete currentData[winner];
            setTimeout(() => {
                rebuildWheelAfterWinner();
            }, 1000);
        }

        async function resetWheel() {
            document.getElementById('game-id').innerText = '';
            currentData = {};
            lastParticipantsKey = "";

            await fetch("https://botcoachbackend.onrender.com/participants", {
                method: 'DELETE'
            });

            await fetchParticipants();
        }
    </script>

    <audio id="victory-audio" preload="auto">
        <source src="sounds/victory.mp3" type="audio/mpeg">
    </audio>
</body>
</html>
